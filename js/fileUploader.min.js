/**************************************************************
 * JavaScript FileUploader
 * @version v1.1.0
 *
 * @description
 * The way to use this plugin is as follows:
 * 	1. Creates a div where the image will be previewed
 *	2. Initialize fileUploader plugin: $(div).fileUploader();
 * 
 * @see https://github.com/lcapps-es/jquery-fileuploader
 * @author LCApps
 * 
 * Copyright (c) 2017 - Licensed MIT
 **************************************************************/
var FileUploader={Types:{IMAGE:"image/*",VIDEO:"video/*"},OnChange:{changeImage:function(e){var a=$(e).attr("id"),t=FileUploader.Files.getFile(a)
FileUploader.Image.getOrientation(t,function(a){var i=new FileReader
i.readAsDataURL(t),i.onload=function(t){FileUploader.Image.changeCanvas(t,e,a)}})},changeVideo:function(e){var a=$(e).attr("id"),t=$(e).prev(),i=FileUploader.Files.getFile(a),n=window.URL||window.webkitURL,r=n.createObjectURL(i)
t.attr("src",r)}},Files:{getFile:function(e){return void 0!==navigator&&void 0!==navigator.galleryCamera?navigator.galleryCamera.getFile(e):void 0!==document.getElementById(e)&&null!==document.getElementById(e)?document.getElementById(e).files[0]:null}},Image:{resizeImage:function(e,a){var t=a.height,i=a.width,n=e.width/e.height
if(e.height>e.width)var r=t,o=r*n
else var o=i,r=o/n
var l=(a.width-o)/2,d=(a.height-r)/2,s=a.getContext("2d")
s.clearRect(0,0,a.width,a.height),s.drawImage(e,l,d,o,r)},changeCanvas:function(e,a,t){var i=$(a).prev().attr("id")
$("#"+i).css({transform:""})
var n=new Image
n.src=e.target.result,n.onload=function(){var e=document.getElementById(i)
FileUploader.Image.resizeImage(n,e),FileUploader.Image.rotate(i,t),$(a).parent().attr("data-changed",1)}},getOrientation:function(e,a){var t=new FileReader
t.readAsArrayBuffer(e),t.onload=function(e){var t=new DataView(e.target.result)
if(65496!=t.getUint16(0,!1))return a(-2)
for(var i=t.byteLength,n=2;n<i;){var r=t.getUint16(n,!1)
if(n+=2,65505==r){if(1165519206!=t.getUint32(n+=2,!1))return a(-1)
var o=18761==t.getUint16(n+=6,!1)
n+=t.getUint32(n+4,o)
var l=t.getUint16(n,o)
n+=2
for(var d=0;d<l;d++)if(274==t.getUint16(n+12*d,o))return a(t.getUint16(n+12*d+8,o))}else{if(65280!=(65280&r))break
n+=t.getUint16(n,!1)}}return a(-1)}},rotate:function(e,a){if(a>0&&a<9){var t=""
2==a?$("#"+e).css({transform:"scaleX(-1)"}):5!=a&&7!=a&&4!=a||(t=" scaleX(-1)"),5==a||6==a?$("#"+e).css({transform:"rotate(90deg)"+t}):3==a||4==a?$("#"+e).css({transform:"rotate(180deg)"+t}):7!=a&&8!=a||$("#"+e).css({transform:"rotate(-90deg)"+t})}}}}
!function(e){function a(e){var e=void 0===e?{}:e,a=r.Options.processOptions(e)
return this.each(function(){r.load(this,a)}),this.getFile=t,this.loadFrom=i,this.fill=n,this}function t(){var a=e(this).attr("id")
return FileUploader.Files.getFile("file_"+a)}function i(a){var t=e(this).attr("id"),i=document.getElementById("file_"+t),n=e(a),o=FileUploader.Files.getFile("file_"+e(n).attr("id"))
r.Makers.setCanvasFromFile(i,o)}function n(a){var t=e(this).attr("id"),i=e(a),n=document.getElementById("file_"+e(i).attr("id")),o=FileUploader.Files.getFile("file_"+t)
r.Makers.setCanvasFromFile(n,o)}var r={Options:{allowedOptions:["defaultImage","readonly","fileType","extraTrigger","autoplay","nocontrols"],validateOptions:function(e){if("object"!=typeof e)throw Error("invalid params")
Object.keys(e).forEach(function(e){if(-1===r.Options.allowedOptions.indexOf(e))throw Error("invalid param: "+e)})},processOptions:function(e){return r.Options.validateOptions(e),void 0===e.fileType&&(e.fileType=FileUploader.Types.IMAGE),1!==e.nocontrols&&!0!==e.nocontrols||(e.autoplay=1),1!==e.autoplay&&!0!==e.autoplay||(e.fileType=FileUploader.Types.VIDEO),e}},Makers:{ImageMakers:{createCanvas:function(a,t,i,n){return e('<canvas id="canvas_'+a+'" width="'+t+'" height="'+i+'"></canvas>')},getChangeName:function(){return"changeImage"}},VideoMakers:{createCanvas:function(a,t,i,n){var r=""
return!n.autoplay||1!=n.autoplay&&1!=n.autoplay||(r+="autoplay "),1!==n.nocontrols&&!0!==n.nocontrols&&(r+="controls "),e("<video "+r+' id="canvas_'+a+'" width="'+t+'" height="'+i+'"></video>')},getChangeName:function(){return"changeVideo"}},Adapter:{get:function(e){if(e.fileType===FileUploader.Types.IMAGE)return r.Makers.ImageMakers
if(e.fileType===FileUploader.Types.VIDEO)return r.Makers.VideoMakers
throw Error("unimplemented option")}},appendElements:function(a,t){var i=e(a).width(),n=e(a).height(),o=e(a).attr("id"),l=r.Makers.Adapter.get(t),d=l.createCanvas(o,i,n,t)
e(a).append(d)
var s=null!==t.fileType?' accept="'+t.fileType+'" ':"",g=e('<input onchange="FileUploader.OnChange.'+l.getChangeName()+'(this)" id="file_'+o+'" type="file" style="display:none" '+s+"/>")
e(a).append(g)},addClickEvents:function(a,t){var i=e(a).attr("id")
1!==t.readonly&&!0!==t.readonly&&e("#canvas_"+i).click(function(){e("#file_"+i).trigger("click")}),void 0!==t.extraTrigger&&null!==t.extraTrigger&&e(t.extraTrigger).length>0&&e(t.extraTrigger).click(function(){e("#file_"+i).trigger("click")})},change:function(a){var t=e(a).attr("id"),i=FileUploader.Files.getFile(t)
r.Makers.setCanvasFromFile(a,i)},setCanvasFromFile:function(e,a){FileUploader.Image.getOrientation(a,function(t){var i=new FileReader
i.readAsDataURL(a),i.onload=function(a){FileUploader.Image.changeCanvas(a,e,t)}})},setDefaultImage:function(a,t){if(void 0!==t.defaultImage&&null!==t.defaultImage){var i=e(a).attr("id"),n="canvas_"+i,r=new Image
r.src=t.defaultImage,r.onload=function(e){var a=document.getElementById(n)
FileUploader.Image.resizeImage(r,a)}}}},load:function(a,t){void 0!==e(a).data("loaded")&&null!==e(a).data("loaded")||(e(a).attr("data-loaded",1),r.Makers.appendElements(a,t),r.Makers.addClickEvents(a,t),r.Makers.setDefaultImage(a,t))}}
e.fn.fileUploader=a}(window.jQuery)
