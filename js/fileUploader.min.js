var FileUploader={Types:{IMAGE:"image/*",VIDEO:"video/*"},OnChange:{changeImage:function(e){var a=$(e).attr("id"),t=FileUploader.Files.getFile(a);FileUploader.Image.getOrientation(t,function(a){var i=new FileReader;i.readAsDataURL(t),i.onload=function(t){FileUploader.Image.changeCanvas(t,e,a)}})},changeVideo:function(e){var a=$(e).attr("id"),t=$(e).prev(),i=FileUploader.Files.getFile(a),n=(window.URL||window.webkitURL).createObjectURL(i);t.attr("src",n)}},Files:{getFile:function(e){return void 0!==navigator&&void 0!==navigator.galleryCamera?navigator.galleryCamera.getFile(e):void 0!==document.getElementById(e)&&null!==document.getElementById(e)?document.getElementById(e).files[0]:null}},Image:{resizeImage:function(e,a){var t=a.height,i=a.width,n=e.width/e.height;if(e.height>e.width)var r=(o=t)*n;else var o=(r=i)/n;var l=(a.width-r)/2,d=(a.height-o)/2,s=a.getContext("2d");s.clearRect(0,0,a.width,a.height),s.drawImage(e,l,d,r,o)},changeCanvas:function(e,a,t){var i=$(a).prev().attr("id");$("#"+i).css({transform:""});var n=new Image;n.src=e.target.result,n.onload=function(){var e=document.getElementById(i);FileUploader.Image.resizeImage(n,e),FileUploader.Image.rotate(i,t),$(a).parent().attr("data-changed",1)}},getOrientation:function(e,a){var t=new FileReader;t.readAsArrayBuffer(e),t.onload=function(e){var t=new DataView(e.target.result);if(65496!=t.getUint16(0,!1))return a(-2);for(var i=t.byteLength,n=2;n<i;){var r=t.getUint16(n,!1);if(n+=2,65505==r){if(1165519206!=t.getUint32(n+=2,!1))return a(-1);var o=18761==t.getUint16(n+=6,!1);n+=t.getUint32(n+4,o);var l=t.getUint16(n,o);n+=2;for(var d=0;d<l;d++)if(274==t.getUint16(n+12*d,o))return a(t.getUint16(n+12*d+8,o))}else{if(65280!=(65280&r))break;n+=t.getUint16(n,!1)}}return a(-1)}},rotate:function(e,a){if(a>0&&a<9){var t="";2==a?$("#"+e).css({transform:"scaleX(-1)"}):5!=a&&7!=a&&4!=a||(t=" scaleX(-1)"),5==a||6==a?$("#"+e).css({transform:"rotate(90deg)"+t}):3==a||4==a?$("#"+e).css({transform:"rotate(180deg)"+t}):7!=a&&8!=a||$("#"+e).css({transform:"rotate(-90deg)"+t})}}}};!function(e){var a={Options:{allowedOptions:["defaultImage","readonly","fileType","extraTrigger","autoplay","nocontrols"],validateOptions:function(e){if("object"!=typeof e)throw Error("invalid params");Object.keys(e).forEach(function(e){if(-1===a.Options.allowedOptions.indexOf(e))throw Error("invalid param: "+e)})},processOptions:function(e){return a.Options.validateOptions(e),void 0===e.fileType&&(e.fileType=FileUploader.Types.IMAGE),1!==e.nocontrols&&!0!==e.nocontrols||(e.autoplay=1),1!==e.autoplay&&!0!==e.autoplay||(e.fileType=FileUploader.Types.VIDEO),e}},Makers:{ImageMakers:{createCanvas:function(a,t,i,n){return e('<canvas id="canvas_'+a+'" width="'+t+'" height="'+i+'"></canvas>')},getChangeName:function(){return"changeImage"}},VideoMakers:{createCanvas:function(a,t,i,n){var r="";return!n.autoplay||1!=n.autoplay&&1!=n.autoplay||(r+="autoplay "),1!==n.nocontrols&&!0!==n.nocontrols&&(r+="controls "),e("<video "+r+' id="canvas_'+a+'" width="'+t+'" height="'+i+'"></video>')},getChangeName:function(){return"changeVideo"}},Adapter:{get:function(e){if(e.fileType===FileUploader.Types.IMAGE)return a.Makers.ImageMakers;if(e.fileType===FileUploader.Types.VIDEO)return a.Makers.VideoMakers;throw Error("unimplemented option")}},appendElements:function(t,i){var n=e(t).width(),r=e(t).height(),o=e(t).attr("id"),l=a.Makers.Adapter.get(i),d=l.createCanvas(o,n,r,i);e(t).append(d);var s=null!==i.fileType?' accept="'+i.fileType+'" ':"",g=e('<input onchange="FileUploader.OnChange.'+l.getChangeName()+'(this)" id="file_'+o+'" type="file" style="display:none" '+s+"/>");e(t).append(g)},addClickEvents:function(a,t){var i=e(a).attr("id");1!==t.readonly&&!0!==t.readonly&&e("#canvas_"+i).click(function(){e("#file_"+i).trigger("click")}),void 0!==t.extraTrigger&&null!==t.extraTrigger&&e(t.extraTrigger).length>0&&e(t.extraTrigger).click(function(){e("#file_"+i).trigger("click")})},change:function(t){var i=e(t).attr("id"),n=FileUploader.Files.getFile(i);a.Makers.setCanvasFromFile(t,n)},setCanvasFromFile(e,a){FileUploader.Image.getOrientation(a,function(t){var i=new FileReader;i.readAsDataURL(a),i.onload=function(a){FileUploader.Image.changeCanvas(a,e,t)}})},setDefaultImage:function(a,t){if(void 0!==t.defaultImage&&null!==t.defaultImage){var i="canvas_"+e(a).attr("id"),n=new Image;n.src=t.defaultImage,n.onload=function(e){var a=document.getElementById(i);FileUploader.Image.resizeImage(n,a)}}}},load:function(t,i){void 0!==e(t).data("loaded")&&null!==e(t).data("loaded")||(e(t).attr("data-loaded",1),a.Makers.appendElements(t,i),a.Makers.addClickEvents(t,i),a.Makers.setDefaultImage(t,i))}};function t(){var a=e(this).attr("id");return FileUploader.Files.getFile("file_"+a)}function i(t){var i=e(this).attr("id"),n=document.getElementById("file_"+i),r=e(t),o=FileUploader.Files.getFile("file_"+e(r).attr("id"));a.Makers.setCanvasFromFile(n,o)}function n(t){var i=e(this).attr("id"),n=e(t),r=document.getElementById("file_"+e(n).attr("id")),o=FileUploader.Files.getFile("file_"+i);a.Makers.setCanvasFromFile(r,o)}e.fn.fileUploader=function(e){e=void 0===e?{}:e;var r=a.Options.processOptions(e);return this.each(function(){a.load(this,r)}),this.getFile=t,this.loadFrom=i,this.fill=n,this}}(window.jQuery);