/**************************************************************
 * JavaScript FileUploader
 * @version v1.1.0
 *
 * @description
 * The way to use this plugin is as follows:
 * 	1. Creates a div where the image will be previewed
 *	2. Initialize fileUploader plugin: $(div).fileUploader();
 * 
 * @see https://github.com/lcapps-es/jquery-fileuploader
 * @author LCApps
 * 
 * Copyright (c) 2017 - Licensed MIT
 **************************************************************/
var FileUploader={Types:{IMAGE:"image/*",VIDEO:"video/*"},OnChange:{changeImage:function(e){var a=$(e).attr("id"),t=FileUploader.Files.getFile(a)
FileUploader.Image.getOrientation(t,function(a){var n=new FileReader
n.readAsDataURL(t),n.onload=function(t){FileUploader.Image.changeCanvas(t,e,a)}})},changeVideo:function(e){var a=$(e).attr("id"),t=$(e).prev(),n=FileUploader.Files.getFile(a),i=window.URL||window.webkitURL,r=i.createObjectURL(n)
t.attr("src",r)}},Files:{getFile:function(e){return void 0!==navigator&&void 0!==navigator.galleryCamera?navigator.galleryCamera.getFile(e):document.getElementById(e).files[0]}},Image:{resizeImage:function(e,a){var t=a.height,n=a.width,i=e.width/e.height
if(e.height>e.width)var r=t,o=r*i
else var o=n,r=o/i
var l=(a.width-o)/2,d=(a.height-r)/2,g=a.getContext("2d")
g.clearRect(0,0,a.width,a.height),g.drawImage(e,l,d,o,r)},changeCanvas:function(e,a,t){var n=$(a).prev().attr("id")
$("#"+n).css({transform:""})
var i=new Image
i.src=e.target.result,i.onload=function(){var e=document.getElementById(n)
FileUploader.Image.resizeImage(i,e),FileUploader.Image.rotate(n,t),$(a).parent().attr("data-changed",1)}},getOrientation:function(e,a){var t=new FileReader
t.readAsArrayBuffer(e),t.onload=function(e){var t=new DataView(e.target.result)
if(65496!=t.getUint16(0,!1))return a(-2)
for(var n=t.byteLength,i=2;i<n;){var r=t.getUint16(i,!1)
if(i+=2,65505==r){if(1165519206!=t.getUint32(i+=2,!1))return a(-1)
var o=18761==t.getUint16(i+=6,!1)
i+=t.getUint32(i+4,o)
var l=t.getUint16(i,o)
i+=2
for(var d=0;d<l;d++)if(274==t.getUint16(i+12*d,o))return a(t.getUint16(i+12*d+8,o))}else{if(65280!=(65280&r))break
i+=t.getUint16(i,!1)}}return a(-1)}},rotate:function(e,a){if(a>0&&a<9){var t=""
2==a?$("#"+e).css({transform:"scaleX(-1)"}):5!=a&&7!=a&&4!=a||(t=" scaleX(-1)"),5==a||6==a?$("#"+e).css({transform:"rotate(90deg)"+t}):3==a||4==a?$("#"+e).css({transform:"rotate(180deg)"+t}):7!=a&&8!=a||$("#"+e).css({transform:"rotate(-90deg)"+t})}}}}
!function(e){function a(e){var e=void 0===e?{}:e,a=t.Options.processOptions(e)
this.each(function(){t.load(this,a)})}var t={Options:{allowedOptions:["defaultImage","readonly","fileType","extraTrigger"],validateOptions:function(e){if("object"!=typeof e)throw Error("invalid params")
Object.keys(e).forEach(function(e){if(-1===t.Options.allowedOptions.indexOf(e))throw Error("invalid param: "+e)})},processOptions:function(e){return t.Options.validateOptions(e),void 0===e.fileType&&(e.fileType=FileUploader.Types.IMAGE),e}},Makers:{ImageMakers:{createCanvas:function(a,t,n){return e('<canvas id="canvas_'+a+'" width="'+t+'" height="'+n+'"></canvas>')},getChangeName:function(){return"changeImage"}},VideoMakers:{createCanvas:function(a,t,n){return e('<video controls id="canvas_'+a+'" width="'+t+'" height="'+n+'"></video>')},getChangeName:function(){return"changeVideo"}},Adapter:{get:function(e){if(e.fileType===FileUploader.Types.IMAGE)return t.Makers.ImageMakers
if(e.fileType===FileUploader.Types.VIDEO)return t.Makers.VideoMakers
throw Error("unimplemented option")}},appendElements:function(a,n){var i=e(a).width(),r=e(a).height(),o=e(a).attr("id"),l=t.Makers.Adapter.get(n),d=l.createCanvas(o,i,r)
e(a).append(d)
var g=null!==n.fileType?' accept="'+n.fileType+'" ':"",s=e('<input onchange="FileUploader.OnChange.'+l.getChangeName()+'(this)" id="file_'+o+'" type="file" style="display:none" '+g+"/>")
e(a).append(s)},addClickEvents:function(a,t){var n=e(a).attr("id")
1!==t.readonly&&!0!==t.readonly&&e("#canvas_"+n).click(function(){e("#file_"+n).trigger("click")}),void 0!==t.extraTrigger&&null!==t.extraTrigger&&e(t.extraTrigger).length>0&&e(t.extraTrigger).click(function(){e("#file_"+n).trigger("click")})},change:function(a){var t=e(a).attr("id"),n=FileUploader.Files.getFile(t)
FileUploader.Image.getOrientation(n,function(e){var t=new FileReader
t.readAsDataURL(n),t.onload=function(t){FileUploader.Image.changeCanvas(t,a,e)}})},setDefaultImage:function(a,t){if(void 0!==t.defaultImage&&null!==t.defaultImage){var n=e(a).attr("id"),i="canvas_"+n,r=new Image
r.src=t.defaultImage,r.onload=function(e){var a=document.getElementById(i)
FileUploader.Image.resizeImage(r,a)}}}},load:function(e,a){t.Makers.appendElements(e,a),t.Makers.addClickEvents(e,a),t.Makers.setDefaultImage(e,a)}}
e.fn.fileUploader=a}(window.jQuery)
